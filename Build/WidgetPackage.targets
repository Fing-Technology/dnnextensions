<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="3.5" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="MSBuild.Community.Tasks.Targets" />
  <Target Name="PackageWidget" Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
    <XmlRead Prefix="n"
                    Namespace="http://schemas.microsoft.com/developer/msbuild/2003"
                    XPath="dotnetnuke/packages/package[1]/@version"
                    XmlFileName="$(DNNFileName).dnn">
      <Output TaskParameter="Value" PropertyName="Version" />
    </XmlRead>

    <PropertyGroup>
      <BuildDependsOn>$(BuildDependsOn);CompressJavascript</BuildDependsOn>
    </PropertyGroup>
    
    <PropertyGroup>
      <InstallTempDir>$(MSBuildProjectDirectory)\WidgetInstallPackageTemp\</InstallTempDir>
      <SourceTempDir>$(MSBuildProjectDirectory)\WidgetSourcePackageTemp\</SourceTempDir>
      <PackageTempDir>$(MSBuildProjectDirectory)\WidgetPackageTemp\</PackageTempDir>
    </PropertyGroup>

    <ItemGroup>
      <WidgetFiles Include=".\**\*.js;.\**\*.css;.\**\*.png;.\**\*.jpg;.\**\*.gif;.\**\*.htc;.\**\*.html;.\**\*.htm;.\**\*.scss;.\**\*.rb;.\**\*.sh" />
    </ItemGroup>    
    <CreateItem Include="$(DNNFileName).dnn">
      <Output TaskParameter="Include" ItemName="ManifestFiles" />
    </CreateItem>
    <CreateItem Include="releasenotes.txt;license.txt">
      <Output TaskParameter="Include" ItemName="TextFiles" />
    </CreateItem>
    <CreateItem Include="*.sln;*.csproj;*.vbproj;*.build">
      <Output TaskParameter="Include" ItemName="SourceFiles" />
    </CreateItem>

    <Copy SourceFiles="@(WidgetFiles)" DestinationFolder="$(SourceTempDir)\%(RecursiveDir)" />
    <Copy SourceFiles="@(ManifestFiles)" DestinationFolder="$(SourceTempDir)" />
    <Copy SourceFiles="@(TextFiles)" DestinationFolder="$(SourceTempDir)" />
    
    <Copy SourceFiles="$(SourceTempDir)\**\*.*" DestinationFolder="$(InstallTempDir)\%(SourceTempDir.RecursiveDir)" ContinueOnError="true" />

    <Copy SourceFiles="@(SourceFiles)" DestinationFolder="$(SourceTempDir)" />

    <ItemGroup>
      <WidgetJS Include="$(InstallTempDir)\**\*.js" />
    </ItemGroup>
    <Message Text="Compresing Javascript files" Importance="high" />
    <JSCompress Files="@(WidgetJS)" />
    
    <!-- Install Package -->
    <CreateItem Include="$(InstallTempDir)\**\*.*">
      <Output TaskParameter="Include" ItemName="InstallPackageOutput" />
    </CreateItem>
    <Copy SourceFiles="@(InstallPackageOutput)" DestinationFolder="$(InstallTempDir)\%(InstallPackageOutput.RecursiveDir)" />
    <Zip Files="@(InstallPackageOutput)" WorkingDirectory="$(InstallTempDir)" ZipFileName="Resources.$(Extension)" />
    <Copy SourceFiles="Resources.$(Extension)" DestinationFolder="$(PackageTempDir)" />
    <CreateItem Include="$(PackageTempDir)\**\*.*">
      <Output TaskParameter="Include" ItemName="InstallZipOutput" />
    </CreateItem>
    <Zip Files="@(InstallZipOutput)" WorkingDirectory="$(PackageTempDir)" ZipFileName="$(PackageName)_Widgets_$(Version)_Install.$(Extension)" />
    <Copy SourceFiles="$(PackageName)_Widgets_$(Version)_Install.$(Extension)" DestinationFolder="$(WebsiteInstallPath)" />
    <Delete Files="Resources.$(Extension)" />

    <!-- Source Package -->
    <CreateItem Include="$(SourceTempDir)\**\*.*">
      <Output TaskParameter="Include" ItemName="SourcePackageOutput" />
    </CreateItem>
    <Copy SourceFiles="@(SourcePackageOutput)" DestinationFolder="$(SourceTempDir)\%(SourcePackageOutput.RecursiveDir)" />
    <Zip Files="@(SourcePackageOutput)" WorkingDirectory="$(SourceTempDir)" ZipFileName="Resources.$(Extension)" />
    <Copy SourceFiles="Resources.$(Extension)" DestinationFolder="$(PackageTempDir)" />
    <CreateItem Include="$(PackageTempDir)\**\*.*">
      <Output TaskParameter="Include" ItemName="SourceZipOutput" />
    </CreateItem>
    <Zip Files="@(SourceZipOutput)" WorkingDirectory="$(PackageTempDir)" ZipFileName="$(PackageName)_Widgets_$(Version)_Source.$(Extension)" />
    <Copy SourceFiles="$(PackageName)_Widgets_$(Version)_Source.$(Extension)" DestinationFolder="$(WebsiteInstallPath)" />

    <!-- CLEAN UP -->
    <Delete Files="$(InstallTempDir)\**\*.*" />
    <Delete Files="$(SourceTempDir)\**\*.*" />
    <Delete Files="$(PackageTempDir)\**\*.*" />
    <Delete Files="$(PackageName)_Widgets_$(Version)_Install.$(Extension)" />
    <Delete Files="$(PackageName)_Widgets_$(Version)_Source.$(Extension)" />
    <RemoveDir Directories="$(InstallTempDir)" />
    <RemoveDir Directories="$(SourceTempDir)" />
    <RemoveDir Directories="$(PackageTempDir)" />

  </Target>
</Project>